<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Play Project - Winged Saviors</title>
    <link href="styles.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
      /* Project Detail Section */
      .project-detail-section {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 800px;
        height: 75vh;
        overflow-y: auto;
        max-height: 90vh;
        margin: 100px auto 20px;
      }

      .project-detail-section h2 {
        color: #2f3645;
        text-align: center;
        margin-bottom: 20px;
        font-size: 2em;
      }

      .project-info {
        margin-bottom: 20px;
      }

      .project-info p {
        font-size: 24px;
        margin: 10px 0;
      }

      .start-stop-container {
        text-align: center;
      }

      .start-stop-container img {
        cursor: pointer;
        width: 250px;
        border-radius: 100%;
        transition: transform 0.3s ease;
      }

      .start-stop-container img.animate {
        transform: scale(1.1);
        transition: transform 0.3s ease;
      }
    </style>
  </head>
  <body>
    <header class="fixed-header">
      <div class="header-content">
        <a href="projectList.html" class="back-button">
          <i class="ph ph-arrow-left"></i
        ></a>
        <img src="img/logo.png" alt="Winged Saviors Logo" class="logo-img" />
        <div class="notification-container">
          <a href="#" class="notification-icon" onclick="togglePopup(event)">
            <i class="ph ph-bell"></i>
          </a>
          <div class="notification-popup" id="notificationPopup">
            <!-- Notification content goes here -->
            <p>This is a notification popup!</p>
          </div>
        </div>
      </div>
    </header>
    <main class="background-image">
      <section class="container project-detail-section">
        <h2>Project Control</h2>
        <div class="project-info">
          <div class="start-stop-container">
            <img src="img/btnOff.png" alt="Start" id="startStopImage" />
            <p id="droneStatus"><strong>Drone Offline</strong></p>
            <br />
            <p id="timer">00:00:00</p>
            <!-- Timer display -->
          </div>
          <p>
            <strong>Project Name:</strong>
            <span id="projectName">Project Alpha</span>
          </p>
          <p>
            <strong>Project Coordinate:</strong>
            <span id="projectCoordinate">128cm</span>
          </p>
          <p>
            <strong>Drone Detection:</strong>
            <span id="droneDetection">People</span>
          </p>
          <p>
            <strong>Previous Processing Time:</strong>
            <span id="totalTime">00:00:00</span>
          </p>
          <!-- Total Time display -->
        </div>
      </section>
    </main>

    <footer>
      <nav class="bottom-nav">
        <ul>
          <li>
            <a href="home.html">
              <i class="ph ph-house"></i><br />
              <span class="nav-name">Home</span>
            </a>
          </li>
          <li>
            <a href="liveFeed.html">
              <i class="ph ph-video-camera"></i><br />
              <span class="nav-name">Live Feed</span>
            </a>
          </li>
          <li>
            <a href="profile.html">
              <i class="ph ph-user"></i><br />
              <span class="nav-name">Profile</span>
            </a>
          </li>
        </ul>
      </nav>
    </footer>

    <script>
      let projectId;

      // Toggle notification popup visibility
      function togglePopup(event) {
        event.preventDefault();
        var popup = document.getElementById("notificationPopup");
        popup.classList.toggle("show");
      }
    </script>
    <script type="module">
      import { setupNoti } from "./notification.js";
      //setupNoti();
    </script>
    <script type="module">
      import { api } from "./conn.js";

      let isStarted = false;
      let timerInterval;
      let startTime;
      let prevTime;

      document.querySelector("#startStopImage").onclick = toggleStartStop;

      function toggleStartStop() {
        const startStopImage = document.getElementById("startStopImage");
        const droneStatus = document.getElementById("droneStatus");

        startStopImage.classList.add("animate");
        setTimeout(() => {
          if (isStarted) {
            stopDrone();
            startStopImage.src = "img/btnOff.png";
            droneStatus.innerHTML = "<strong>Drone Offline</strong>";
            isStarted = false;
          } else {
            startDrone();
            startStopImage.src = "img/btnOn.png";
            droneStatus.innerHTML = "<strong>Drone Online</strong>";
            isStarted = true;
          }
          startStopImage.classList.remove("animate");
        }, 300); // duration matches the CSS animation
      }

      function startDrone() {
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get("project");
        localStorage.setItem("project", projectId);

        // Make an AJAX request to start the drone
        fetch(api(`/start_drone?project=${projectId}`))
          .then((response) => {
            response.text().then(console.log);
            if (!response.ok) {
              throw new Error("Failed to start drone");
            }
            console.log("Drone started successfully");
            startTimer(); // Start the timer
            // Optionally, update UI or perform additional actions upon successful start
          })
          .catch((error) => {
            console.error("Error starting drone:", error);
            alert("Failed to start the drone");
          });
      }

      function stopDrone() {
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get("project");
        const duration = stopTimer(); // Stop the timer and get the duration

        fetch(api(`/stop_drone?project=${projectId}`))
          .then((response) => {
            if (!response.ok) {
              throw new Error("Failed to stop drone");
            }
            console.log("Drone stopped successfully");
            // Optionally, update UI or perform additional actions upon successful stop
          })
          .catch((error) => {
            console.error("Error stopping drone:", error);
            alert("Failed to stop the drone");
          });
      }

      function startTimer() {
        if (!startTime) {
          startTime = new Date();
        }
        timerInterval = setInterval(() => {
          const now = new Date();
          const elapsed = new Date(now - startTime);
          const elapsed2 = new Date(elapsed.getTime() - prevTime);

          const hours = String(elapsed2.getUTCHours()).padStart(2, "0");
          const minutes = String(elapsed2.getUTCMinutes()).padStart(2, "0");
          const seconds = String(elapsed2.getUTCSeconds()).padStart(2, "0");
          console.log(projectId);
          /**
          fetch(
            api(
              `/update_timer?project=${projectId}&timer=${
                elapsed.getTime() / 1000
              }`
            )
          )
            .then((res) => res.json())
            .then((res) => {
              console.log(res);
            })
            .catch((err) => {
              console.error(err);
            });
          */
          document.getElementById(
            "timer"
          ).textContent = `${hours}:${minutes}:${seconds}`;
        }, 1000);
      }

      function stopTimer() {
        clearInterval(timerInterval);
        document.getElementById("timer").textContent = "00:00:00";
        const endTime = new Date();
        const duration = (endTime - startTime) / 1000; // Duration in seconds
        console.log(duration);

        // Format the duration to HH:MM:SS
        const hours = String(Math.floor(duration / 3600)).padStart(2, "0");
        const minutes = String(Math.floor((duration % 3600) / 60)).padStart(
          2,
          "0"
        );
        const seconds = String(Math.floor(duration % 60)).padStart(2, "0");
        document.getElementById(
          "totalTime"
        ).textContent = `${hours}:${minutes}:${seconds}`;

        return duration;
      }

      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const projectId1 = urlParams.get("project");
        console.log("123");
        if (projectId1) {
          projectId = projectId1;
          loadProjectDetails(projectId1);
        }
      });

      async function loadProjectDetails(projectId) {
        try {
          const res = await fetch(api("/check_project?project=" + projectId));

          if (res.status !== 200) {
            alert("Project not found!");
            window.location.href = "projectList.html";
            return;
          }

          const data = await res.json();
          console.log(data);

          startTime = new Date(new Date().getTime() - data.timer * 1000);
          let duration = data.timer;
          prevTime = data.timer * 1000;

          // Format the duration to HH:MM:SS
          const hours = String(Math.floor(duration / 3600)).padStart(2, "0");
          const minutes = String(Math.floor((duration % 3600) / 60)).padStart(
            2,
            "0"
          );
          const seconds = String(Math.floor(duration % 60)).padStart(2, "0");
          document.getElementById(
            "totalTime"
          ).textContent = `${hours}:${minutes}:${seconds}`;

          document.querySelector("#projectName").textContent = data.name;
          document.querySelector("#projectCoordinate").textContent =
            data.coordinate;
          document.querySelector("#droneDetection").textContent = data.detect;
        } catch (err) {
          console.error(err);
        }
      }
    </script>
  </body>
</html>
