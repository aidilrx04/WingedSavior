<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Controller</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="video.css" />
  </head>
  <body>
    <style>
      @media screen and (orientation: potrait) {
        #potrait-warning {
          display: block;
        }
      }
    </style>
    <div id="potrait-warning" style="display: none">please use landscape</div>
    <div id="controller-page">
      <img
        src="img/Aidil.jpg"
        alt=""
        id="video-src"
        oncontextmenu="return false"
      />
      <div class="controllers">
        <div class="top-bar">
          <div class="left-actions">
            <button id="stop"><i class="ph-fill ph-stop"></i></button>
            <button id="play"><i class="ph-fill ph-play"></i></button>
            <button id="connect"><i class="ph-fill ph-plugs"></i></button>
          </div>
          <div class="statuses">
            <span class="status">
              <i class="ph-fill ph-battery-full"></i>
              <span id="battery-label">69 %</span>
            </span>
            <span class="status">
              <i class="ph-fill ph-airplane-in-flight"></i>
              <span id="altitude-label">2.0 m</span>
            </span>
            <div class="status">
              <i class="ph-fill ph-map-pin"></i>
              <span id="location-label">100.00, 100.00</span>
            </div>
          </div>
          <div class="right-actions">
            <button id="notification">
              <i class="ph-fill ph-bell-simple"></i>
            </button>
            <button id="setting-btn"><i class="ph-fill ph-gear"></i></button>
          </div>
        </div>
        <div class="actions">
          <div class="left">
            <button id="up"><i class="ph ph-arrow-fat-line-up"></i></button>
            <button id="down">
              <i class="ph-bold ph-arrow-fat-line-down"></i>
            </button>
            <button id="rotate-left">
              <i class="ph ph-arrow-counter-clockwise"></i>
            </button>
            <button id="rotate-right">
              <i class="ph ph-arrow-clockwise"></i>
            </button>
          </div>
          <div class="right">
            <button id="forward"><i class="ph-fill ph-caret-up"></i></button>
            <button id="backward"><i class="ph-fill ph-caret-down"></i></button>
            <button id="strafe-left">
              <i class="ph-fill ph-caret-left"></i>
            </button>
            <button id="strafe-right">
              <i class="ph-fill ph-caret-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="jquery.min.js"></script>

    <script type="module">
      import { ws, requiredProject, api } from "./conn.js";

      // load project
      const projectId = localStorage.getItem("project");

      $(function () {
        const $movements = $(
          "#up,#down,#rotate-left,#rotate-right,#forward,#backward,#strafe-left,#strafe-right"
        );

        // disble context menu on whole page
        $("*").on("contextmenu", function (e) {
          e.preventDefault();
          return false;
        });

        let socket;
        let isConnected = false;
        let status = null;

        const listeners = {};

        try {
          socket = new WebSocket(ws());
          socket.addEventListener("open", function () {
            console.log("Ws server connected");
            isConnected = false;
          });
          socket.addEventListener("message", handleMessageEvent);
          socket.addEventListener("close", function () {
            isConnected = false;
          });
        } catch (err) {
          console.error(err);
        }

        function listen(event, cb) {
          listeners[event] = listeners[event]
            ? [...listeners[event], cb]
            : [cb];
        }

        function handleMessageEvent(e) {
          const [event, ...data] = e.data.split(" ");
          console.log(data.join(" "));

          if (listeners[event]) {
            for (const cb of listeners[event]) cb(data.join(" "));
          }
        }

        listen("status", function (e) {
          status = JSON.parse(e);
          updateStatus();
        });

        function updateStatus() {
          let { location } = status;

          updateLocation(location);
        }

        function updateLocation(location) {
          const $locLabel = $("#location-label");
          let locLabel;
          if (location === null) locLabel = "Unavailable";
          else locLabel = `${location.lat}, ${location.lng}`;
          $locLabel.text(locLabel);
        }

        $("#connect").on("click", function () {
          socket.send("connect");
        });
        $("#play").on("click", function () {
          socket.send("takeoff");
        });
        $("#stop").on("click", function () {
          socket.send("land");
        });

        requiredProject(async (projectId) => {
          // check video feed
          try {
            const res = await fetch(api("/video_feed?status=true"));
            const data = await res.json();

            if (data.video_start) {
              $("#video-src").prop(
                "src",
                api("/video_feed?project=" + projectId)
              );
            }
          } catch (e) {
            console.error(e);
          }
        });
      });
    </script>
  </body>
</html>
